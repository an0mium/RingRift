# =============================================================================
# RingRift Environment Configuration
# =============================================================================
#
# This file documents all environment variables used by RingRift.
# Copy this file to `.env` for local development.
#
# SECURITY NOTES:
# - The `.env` file is gitignored and should NEVER be committed
# - In production, use proper secrets management (e.g., Kubernetes Secrets,
#   AWS Secrets Manager, HashiCorp Vault)
# - All placeholder secrets in this file are detected and rejected in production
#
# ENVIRONMENT SUPPORT:
# - development: Local development with sensible defaults
# - staging: Pre-production environment with production-like validation
# - production: Production environment with strict validation
# - test: Automated testing environment
#
# For detailed secrets management guidance, see: docs/SECRETS_MANAGEMENT.md
# For complete environment variable documentation, see: docs/ENVIRONMENT_VARIABLES.md
# =============================================================================


# =============================================================================
# ENVIRONMENT MODE
# =============================================================================

# Application environment mode
# Values: development | staging | production | test
# Default: development
# 
# In production/staging, many optional variables become required and
# placeholder values are rejected with clear error messages.
NODE_ENV=development


# =============================================================================
# SERVER CONFIGURATION
# =============================================================================

# HTTP server port for the main API
# Type: number (1-65535)
# Default: 3000
PORT=3000

# Server bind address
# Type: string
# Default: 0.0.0.0
HOST=0.0.0.0

# WebSocket server port (legacy, may not be used if WS is on same port)
# Type: number
# Default: 3001
SOCKET_PORT=3001


# =============================================================================
# DATABASE (REQUIRED in production)
# =============================================================================
# PostgreSQL connection URL containing credentials.
#
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE
#
# SECURITY:
# - Required in production (server will fail to start without it)
# - Contains credentials - never log or expose this value
# - Use strong passwords (16+ characters, mixed chars)
#
# Secret Rotation:
# 1. Create new database user with new password
# 2. Grant same permissions as old user
# 3. Update DATABASE_URL environment variable
# 4. Restart application
# 5. Verify connectivity, then revoke old user

DATABASE_URL=postgresql://ringrift:password@localhost:5432/ringrift

# Database connection pool settings
# Type: number
# Defaults: min=2, max=10
DATABASE_POOL_MIN=2
DATABASE_POOL_MAX=10

# Individual database components (used by some tools, not Prisma)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ringrift
DB_USER=ringrift
# PLACEHOLDER - change for any non-local deployment
DB_PASSWORD=password


# =============================================================================
# REDIS (Optional in dev, REQUIRED in production)
# =============================================================================
# Redis connection URL for caching, sessions, and pub/sub.
#
# SECURITY:
# - Required in production for session management
# - Use TLS in production (rediss:// prefix)
# - Set REDIS_PASSWORD for authenticated access
#
# Secret Rotation:
# 1. Configure new password in Redis (CONFIG SET requirepass newpassword)
# 2. Update REDIS_PASSWORD environment variable
# 3. Restart application
# 4. Verify connectivity

REDIS_URL=redis://localhost:6379
REDIS_HOST=localhost
REDIS_PORT=6379

# Optional - leave empty for local development without auth
REDIS_PASSWORD=

# Enable TLS for Redis connections (use rediss:// URL in production)
# Type: boolean (true/false, 1/0)
# Default: false
REDIS_TLS=false


# =============================================================================
# JWT / AUTHENTICATION (REQUIRED in production)
# =============================================================================
# JWT secrets for signing and verifying authentication tokens.
#
# REQUIREMENTS (Production):
# - JWT_SECRET: Minimum 32 characters, randomly generated
# - JWT_REFRESH_SECRET: Minimum 32 characters, different from JWT_SECRET
# - Both must NOT be placeholder values (detected and rejected)
#
# Generate secure secrets:
#   openssl rand -base64 48
#   # or: node -e "console.log(require('crypto').randomBytes(48).toString('base64'))"
#
# SECURITY:
# - Never reuse secrets across environments
# - Never commit real secrets to version control
# - Tokens signed with old secrets become invalid on rotation
#
# Secret Rotation:
# 1. Generate new JWT_SECRET and JWT_REFRESH_SECRET
# 2. Update environment variables
# 3. Restart application
# 4. All existing sessions will be invalidated (users must re-login)
# 5. For zero-downtime rotation, implement key versioning

# PLACEHOLDER - server rejects these in production mode
JWT_SECRET=your-super-secret-jwt-key-change-this-in-production
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-this-in-production

# Token expiration times
# Type: string (duration format: 15m, 1h, 7d)
# Access tokens: Short-lived (default: 15 minutes)
JWT_EXPIRES_IN=15m
# Refresh tokens: Longer-lived (default: 7 days)
JWT_REFRESH_EXPIRES_IN=7d


# =============================================================================
# AUTH LOGIN LOCKOUT
# =============================================================================
# Login protection against brute-force attacks.
# These settings are intentionally conservative for development.

# Maximum failed login attempts before lockout
# Type: number
# Default: 10
AUTH_MAX_FAILED_LOGIN_ATTEMPTS=10

# Time window for counting failed login attempts (seconds)
# Type: number
# Default: 900 (15 minutes)
AUTH_FAILED_LOGIN_WINDOW_SECONDS=900

# Duration of login lockout (seconds)
# Type: number
# Default: 900 (15 minutes)
AUTH_LOCKOUT_DURATION_SECONDS=900

# Enable/disable login lockout feature
# Type: string (true/false, 1/0)
# Default: true (enabled when not set)
# Set to "false" or "0" to disable globally
AUTH_LOGIN_LOCKOUT_ENABLED=true


# =============================================================================
# SECURITY SETTINGS
# =============================================================================

# bcrypt rounds for password hashing (higher = more secure but slower)
# Type: number (4-31)
# Default: 12 (good balance for production)
BCRYPT_ROUNDS=12


# =============================================================================
# RATE LIMITING
# =============================================================================
# Rate limiting is enforced using Redis for distributed deployments or
# in-memory storage for single-instance/development environments.
#
# Each endpoint type has configurable limits. All values are:
# - POINTS: Maximum number of requests allowed in the window
# - DURATION: Window duration in seconds
# - BLOCK_DURATION: How long to block after limit exceeded (seconds)
#
# Rate limit headers are included in all responses:
# - X-RateLimit-Limit: Maximum requests in the window
# - X-RateLimit-Remaining: Remaining requests in current window
# - X-RateLimit-Reset: Unix timestamp when the window resets

# --- General API endpoints (anonymous users) ---
# Lower limits for unauthenticated requests
RATE_LIMIT_API_POINTS=50
RATE_LIMIT_API_DURATION=60
RATE_LIMIT_API_BLOCK_DURATION=300

# --- General API endpoints (authenticated users) ---
# Higher limits for authenticated users
RATE_LIMIT_API_AUTH_POINTS=200
RATE_LIMIT_API_AUTH_DURATION=60
RATE_LIMIT_API_AUTH_BLOCK_DURATION=300

# --- Auth endpoints (general) ---
# Applied to all authentication routes
RATE_LIMIT_AUTH_POINTS=10
RATE_LIMIT_AUTH_DURATION=900
RATE_LIMIT_AUTH_BLOCK_DURATION=1800

# --- Login endpoint (stricter) ---
# Protects against brute force attacks
RATE_LIMIT_AUTH_LOGIN_POINTS=5
RATE_LIMIT_AUTH_LOGIN_DURATION=900
RATE_LIMIT_AUTH_LOGIN_BLOCK_DURATION=1800

# --- Registration endpoint (stricter) ---
# Prevents spam account creation
RATE_LIMIT_AUTH_REGISTER_POINTS=3
RATE_LIMIT_AUTH_REGISTER_DURATION=3600
RATE_LIMIT_AUTH_REGISTER_BLOCK_DURATION=3600

# --- Password reset endpoint ---
# Prevents abuse of password reset functionality
RATE_LIMIT_AUTH_PWD_RESET_POINTS=3
RATE_LIMIT_AUTH_PWD_RESET_DURATION=3600
RATE_LIMIT_AUTH_PWD_RESET_BLOCK_DURATION=3600

# --- Game endpoints ---
# Applied to game management operations
RATE_LIMIT_GAME_POINTS=200
RATE_LIMIT_GAME_DURATION=60
RATE_LIMIT_GAME_BLOCK_DURATION=300

# --- Game moves ---
# Higher limits for active gameplay
RATE_LIMIT_GAME_MOVES_POINTS=100
RATE_LIMIT_GAME_MOVES_DURATION=60
RATE_LIMIT_GAME_MOVES_BLOCK_DURATION=60

# --- WebSocket connections ---
# Limits new WebSocket connections
RATE_LIMIT_WS_POINTS=10
RATE_LIMIT_WS_DURATION=60
RATE_LIMIT_WS_BLOCK_DURATION=300

# --- Game creation per user ---
# Prevents users from creating too many games
RATE_LIMIT_GAME_CREATE_USER_POINTS=20
RATE_LIMIT_GAME_CREATE_USER_DURATION=600
RATE_LIMIT_GAME_CREATE_USER_BLOCK_DURATION=600

# --- Game creation per IP ---
# Additional protection for game creation
RATE_LIMIT_GAME_CREATE_IP_POINTS=50
RATE_LIMIT_GAME_CREATE_IP_DURATION=600
RATE_LIMIT_GAME_CREATE_IP_BLOCK_DURATION=600

# --- Fallback limiter (in-memory only) ---
# Used when Redis is unavailable
RATE_LIMIT_FALLBACK_WINDOW_MS=900000
RATE_LIMIT_FALLBACK_MAX_REQUESTS=100


# =============================================================================
# CORS CONFIGURATION
# =============================================================================
# Cross-Origin Resource Sharing settings for browser security.
#
# In production, set these to your actual domain(s).

# Primary CORS origin for API requests
CORS_ORIGIN=http://localhost:5173

# Public client URL for redirects etc.
CLIENT_URL=http://localhost:3000

# Comma-separated list of allowed origins
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000


# =============================================================================
# LOGGING
# =============================================================================

# Application log level
# Values: error | warn | info | debug | trace
# Default: info
LOG_LEVEL=info

# Log output format
# Values: json | pretty
# Default: json (production), pretty (development recommended)
LOG_FORMAT=json

# Log file path (optional, logs also go to stdout)
LOG_FILE=./logs/app.log


# =============================================================================
# FEATURE FLAGS
# =============================================================================

# Enable Prometheus metrics endpoint
# Type: boolean (true/false, 1/0)
# Default: true
ENABLE_METRICS=true

# Enable health check endpoints
# Type: boolean (true/false, 1/0)
# Default: true
ENABLE_HEALTH_CHECKS=true

# Metrics server port
# Type: number (1-65535)
# Default: 9090
METRICS_PORT=9090


# =============================================================================
# FILE STORAGE
# =============================================================================

# Directory for user uploads (relative to project root)
UPLOAD_DIR=./uploads

# Maximum upload file size in bytes (default: 5MB)
MAX_FILE_SIZE=5242880


# =============================================================================
# GAME CONFIGURATION
# =============================================================================

# Maximum concurrent games allowed
# Type: number
# Default: 1000
MAX_CONCURRENT_GAMES=1000

# Game timeout in minutes (inactive games are cleaned up)
# Type: number
# Default: 60
GAME_TIMEOUT_MINUTES=60

# AI thinking time in milliseconds
# Type: number
# Default: 2000
AI_THINK_TIME_MS=2000

# Maximum spectators per game
# Type: number
# Default: 50
MAX_SPECTATORS_PER_GAME=50


# =============================================================================
# AI SERVICE (REQUIRED in production)
# =============================================================================
# FastAPI-based AI service for opponent moves and game analysis.
#
# SECURITY:
# - Required in production (server will fail to start without it)
# - In Docker Compose, use internal DNS: http://ai-service:8001
# - Never expose AI service directly to the internet
#
# The AI service does not require additional secrets currently.

# AI service base URL
# Required in production, defaults to http://localhost:8001 in development
AI_SERVICE_URL=http://localhost:8001

# AI service port (used when running ai-service directly)
AI_SERVICE_PORT=8001

# Request timeout in milliseconds
# Type: number
# Default: 5000
AI_SERVICE_REQUEST_TIMEOUT_MS=5000
AI_RULES_REQUEST_TIMEOUT_MS=5000

# Maximum concurrent AI requests (backpressure control)
# Type: number
# Default: 16
AI_MAX_CONCURRENT_REQUESTS=16

# Enable AI fallback to local heuristics when service unavailable
# Type: boolean (true/false, 1/0)
# Default: true
AI_FALLBACK_ENABLED=true

# AI service log level (for ai-service container)
AI_LOG_LEVEL=INFO


# =============================================================================
# RULES ENGINE
# =============================================================================
# Rules engine mode for game logic execution.
#
# Options:
#   ts (default) - TypeScript engine only
#   shadow       - Python runs in parallel for validation (development)
#   python       - Python engine is authoritative

# RINGRIFT_RULES_MODE=shadow


# =============================================================================
# APPLICATION TOPOLOGY
# =============================================================================
# How the application is deployed.
#
# Options:
#   single (default) - Single instance, all state in memory
#   multi-unsafe     - Multiple instances without sticky sessions (NOT RECOMMENDED)
#   multi-sticky     - Multiple instances with infrastructure-enforced sticky sessions
#
# WARNING: Do not use multi-* without proper session affinity configuration.

# RINGRIFT_APP_TOPOLOGY=single


# =============================================================================
# EMAIL (OPTIONAL)
# =============================================================================
# SMTP configuration for sending emails (password reset, notifications, etc.)
#
# These settings are optional. If not configured, email features will be disabled.

# SMTP_HOST=smtp.example.com
# SMTP_PORT=587
# SMTP_USER=user@example.com
# SMTP_PASSWORD=secret
# SMTP_TLS=true
# SMTP_FROM=noreply@ringrift.com


# =============================================================================
# CLIENT/FRONTEND CONFIGURATION
# =============================================================================
# These VITE_* variables are exposed to the React client via import.meta.env
# and are embedded in the built JavaScript bundle.
#
# WARNING: Never put secrets in VITE_* variables - they are public!

# Enable client-side error reporting
# VITE_ERROR_REPORTING_ENABLED=true

# Endpoint for error reports
# VITE_ERROR_REPORTING_ENDPOINT=/api/client-errors

# Maximum errors to report per session
# VITE_ERROR_REPORTING_MAX_EVENTS=50


# =============================================================================
# DEVELOPMENT/DEBUG FLAGS
# =============================================================================
# These flags are for development and debugging purposes only.
# Do not enable in production.

# Enable sandbox AI stall diagnostics
# RINGRIFT_ENABLE_SANDBOX_AI_STALL_DIAGNOSTICS=false

# Enable sandbox capture debug logging
# RINGRIFT_SANDBOX_CAPTURE_DEBUG=false

# Enable sandbox AI capture debug logging
# RINGRIFT_SANDBOX_AI_CAPTURE_DEBUG=false

# Enable sandbox AI trace mode
# RINGRIFT_SANDBOX_AI_TRACE_MODE=false

# Enable sandbox AI parity mode
# RINGRIFT_SANDBOX_AI_PARITY_MODE=false

# Enable local AI heuristic mode
# RINGRIFT_LOCAL_AI_HEURISTIC_MODE=false