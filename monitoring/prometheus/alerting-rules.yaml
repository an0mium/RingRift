groups:
  - name: ringrift-ai-alerts
    rules:
      # Elo Regression Alert
      - alert: EloRegression
        expr: |
          (
            max_over_time(ringrift_best_elo[1h]) - ringrift_best_elo
          ) > 50
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Elo regression detected for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Best Elo dropped by more than 50 points in the last hour. Current: {{ $value | printf "%.1f" }}'

      # Training Stalled
      - alert: TrainingStalled
        expr: |
          time() - ringrift_last_training_time > 7200
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: 'Training stalled for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'No training completed in the last 2 hours'

      # Low Game Generation
      - alert: LowGameGeneration
        expr: |
          ringrift_games_per_hour < 10
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Low game generation for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Game generation rate dropped below 10 games/hour: {{ $value | printf "%.1f" }}'

      # High Training Loss
      - alert: HighTrainingLoss
        expr: |
          ringrift_training_loss > 2.0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'High training loss for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Training loss is unusually high: {{ $value | printf "%.3f" }}'

      # Node Down
      - alert: NodeDown
        expr: |
          ringrift_node_alive == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Cluster node {{ $labels.node }} is down'
          description: 'Node has been unreachable for 5 minutes'

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: |
          ringrift_memory_percent > 90
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: 'High memory usage on {{ $labels.node }}'
          description: 'Memory usage is {{ $value | printf "%.1f" }}%'

      # GPU Memory Full
      - alert: GPUMemoryFull
        expr: |
          ringrift_gpu_memory_percent > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'GPU memory nearly full on {{ $labels.node }}'
          description: 'GPU memory usage is {{ $value | printf "%.1f" }}%'

      # Stale Training Data
      - alert: StaleTrainingData
        expr: |
          ringrift_data_freshness_hours > 6
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Training data is stale for {{ $labels.config }}'
          description: 'Newest training data is {{ $value | printf "%.1f" }} hours old'

      # Improvement Loop Stuck
      - alert: ImprovementLoopStuck
        expr: |
          increase(ringrift_improvement_cycles_total[6h]) == 0
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Improvement loop appears stuck'
          description: 'No improvement cycles completed in the last 6 hours'

      # Promotion Failures
      - alert: HighPromotionFailures
        expr: |
          ringrift_promotion_success_rate < 0.2
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'High promotion failure rate'
          description: 'Model promotion success rate is only {{ $value | printf "%.1f" }}%'

      # Opening Diversity Drop
      - alert: LowOpeningDiversity
        expr: |
          ringrift_opening_diversity < 10
        for: 2h
        labels:
          severity: info
        annotations:
          summary: 'Low opening diversity for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value }} unique openings seen - may indicate collapsed search'

      # Overfitting Detected
      - alert: OverfitDetected
        expr: |
          ringrift_overfit_gap > 0.15
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Overfitting detected for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Holdout loss exceeds training loss by {{ $value | printf "%.3f" }} - model may be overfitting'

      # Low Holdout Accuracy
      - alert: LowHoldoutAccuracy
        expr: |
          ringrift_holdout_accuracy < 0.70
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Low holdout accuracy for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Holdout accuracy is {{ $value | printf "%.1f" }}% - model generalization may be poor'

      # Insufficient Holdout Data
      - alert: InsufficientHoldoutData
        expr: |
          ringrift_holdout_games < 100
        for: 24h
        labels:
          severity: info
        annotations:
          summary: 'Insufficient holdout data for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value }} holdout games available - need more data for reliable overfitting detection'

      # MCTS Search Quality
      - alert: LowMCTSSearchDepth
        expr: |
          ringrift_mcts_avg_depth < 3
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'Low MCTS search depth detected'
          description: 'Average search depth is only {{ $value | printf "%.1f" }} - may indicate resource constraints or slow evaluation'

      # Data Quality Issues
      - alert: HighShortGameRate
        expr: |
          ringrift_data_quality_short_rate > 15
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'High short game rate for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: '{{ $value | printf "%.1f" }}% of games are under 10 moves - may indicate degenerate training data'

      - alert: DataQualityIssuesDetected
        expr: |
          ringrift_data_quality_issues > 3
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Multiple data quality issues detected'
          description: '{{ $value }} data quality issues found - check /data/quality/issues endpoint'

      # Training Efficiency
      - alert: LowTrainingEfficiency
        expr: |
          ringrift_elo_per_gpu_hour < 0.5
        for: 6h
        labels:
          severity: info
        annotations:
          summary: 'Low training efficiency for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value | printf "%.2f" }} Elo/GPU-hour - consider adjusting hyperparameters'

      - alert: HighTrainingCost
        expr: |
          ringrift_training_cost_usd > 100
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'High training cost for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Estimated cost is ${{ $value | printf "%.2f" }} - monitor for budget'

      # Rollback Recommendations
      - alert: RollbackRecommended
        expr: |
          ringrift_rollback_candidates > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Model rollback recommended'
          description: '{{ $value }} config(s) have rollback recommendations - check /rollback/status'

      # Autoscaling
      - alert: LowClusterThroughput
        expr: |
          ringrift_cluster_games_per_hour < 20
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'Low cluster throughput'
          description: 'Only {{ $value | printf "%.0f" }} games/hour - consider scaling up workers'

      - alert: ScaleUpRecommended
        expr: |
          ringrift_autoscale_suggested_workers > (count(ringrift_node_alive == 1) + 1)
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'Scale-up recommended'
          description: 'Autoscaler suggests {{ $value }} workers - current cluster may be undersized'

      # Stratified Holdout Validation Alerts
      - alert: WeakOpeningPhase
        expr: |
          ringrift_holdout_accuracy{phase="opening"} < 0.60
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Weak opening phase accuracy for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Opening phase accuracy is {{ $value | printf "%.1f" }}% - model struggles with early game positions'

      - alert: WeakEndgamePhase
        expr: |
          ringrift_holdout_accuracy{phase="endgame"} < 0.60
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: 'Weak endgame phase accuracy for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Endgame phase accuracy is {{ $value | printf "%.1f" }}% - model struggles with late game positions'

      - alert: PhaseAccuracyImbalance
        expr: |
          max(ringrift_holdout_accuracy) by (board_type, num_players) - min(ringrift_holdout_accuracy) by (board_type, num_players) > 0.15
        for: 2h
        labels:
          severity: info
        annotations:
          summary: 'Phase accuracy imbalance for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Large gap between phase accuracies - consider phase-specific training'

      # Curriculum Learning Alerts
      - alert: CurriculumAllTooEasy
        expr: |
          count(ringrift_curriculum_winrate > 0.70) by (board_type, num_players) >= 8
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'Curriculum too easy for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Model beats most difficulty levels >70% - needs harder opponents or self-play'

      - alert: CurriculumAllTooHard
        expr: |
          count(ringrift_curriculum_winrate < 0.30) by (board_type, num_players) >= 5
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'Curriculum too hard for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Model loses to most difficulty levels - may need easier opponents or more training'

      - alert: CurriculumNoOptimalDifficulty
        expr: |
          count(ringrift_curriculum_winrate > 0.45 and ringrift_curriculum_winrate < 0.65) by (board_type, num_players) == 0
        for: 4h
        labels:
          severity: info
        annotations:
          summary: 'No optimal difficulty level for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'No opponents in the 45-65% win rate sweet spot - curriculum may not be optimal'

      # Ensemble Alerts
      - alert: EnsembleCreationFailed
        expr: |
          increase(ringrift_ensemble_failures_total[6h]) > 2
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Ensemble creation failures for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: '{{ $value }} ensemble creation failures in last 6 hours'

      - alert: EnsembleStale
        expr: |
          time() - ringrift_last_ensemble_time > 172800
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'Stale ensemble for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'No ensemble created in 48+ hours - may be missing model diversity benefits'

      # A/B Testing Alerts
      - alert: ABTestStalled
        expr: |
          ringrift_abtest_games_remaining > 0 and increase(ringrift_abtest_games_played[2h]) == 0
        for: 2h
        labels:
          severity: warning
        annotations:
          summary: 'A/B test stalled'
          description: 'A/B test {{ $labels.test_id }} has {{ $value }} games remaining but no progress in 2 hours'

      - alert: ABTestLowConfidence
        expr: |
          ringrift_abtest_games_played > 80 and ringrift_abtest_confidence < 0.80
        for: 1h
        labels:
          severity: info
        annotations:
          summary: 'A/B test inconclusive after many games'
          description: 'A/B test {{ $labels.test_id }} has {{ $value }} games but only {{ $labels.confidence }}% confidence - models may be equal'

      # Data Quality Gating Alerts
      - alert: TrainingBlockedByQuality
        expr: |
          increase(ringrift_training_blocked_by_quality_total[1h]) > 0
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Training blocked by data quality for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Data quality issues preventing training - check /data/quality endpoint'

      - alert: PersistentQualityIssues
        expr: |
          ringrift_data_quality_issues > 3
        for: 6h
        labels:
          severity: warning
        annotations:
          summary: 'Persistent data quality issues for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: '{{ $value }} quality issues detected for 6+ hours - investigate data generation'

      # Training Efficiency Alerts
      - alert: NegativeEloPerGPUHour
        expr: |
          ringrift_elo_per_gpu_hour < 0
        for: 6h
        labels:
          severity: warning
        annotations:
          summary: 'Negative Elo/GPU-hour for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Training is making model worse - {{ $value | printf "%.2f" }} Elo/GPU-hr. Consider rollback.'

      - alert: VeryLowTrainingROI
        expr: |
          ringrift_elo_per_gpu_hour > 0 and ringrift_elo_per_gpu_hour < 0.1
        for: 12h
        labels:
          severity: info
        annotations:
          summary: 'Very low training ROI for {{ $labels.board_type }}_{{ $labels.num_players }}p'
          description: 'Only {{ $value | printf "%.2f" }} Elo/GPU-hr - may have hit improvement ceiling'

      # ==========================================================================
      # Pressure Monitoring Alerts (2025-12)
      # ==========================================================================

      # Memory Pressure Critical
      - alert: MemoryPressureCritical
        expr: |
          ringrift_memory_pressure_level >= 3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Critical memory pressure detected'
          description: 'Memory pressure level is {{ $value }} (CRITICAL/EMERGENCY). Auto-cleanup triggered.'

      # Disk Pressure Critical
      - alert: DiskPressureCritical
        expr: |
          ringrift_disk_pressure_level >= 3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Critical disk pressure detected'
          description: 'Disk pressure level is {{ $value }} (CRITICAL/EMERGENCY). Auto-cleanup triggered.'

      # Sustained Memory Pressure Warning
      - alert: MemoryPressureWarning
        expr: |
          ringrift_memory_pressure_level >= 2
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Sustained memory pressure detected'
          description: 'Memory pressure has been ELEVATED or higher for 30 minutes - consider scaling resources'

      # Sustained Disk Pressure Warning
      - alert: DiskPressureWarning
        expr: |
          ringrift_disk_pressure_level >= 2
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: 'Sustained disk pressure detected'
          description: 'Disk pressure has been ELEVATED or higher for 30 minutes - check cleanup jobs'

      # Frequent Pressure Cleanup
      - alert: FrequentPressureCleanup
        expr: |
          increase(ringrift_pressure_cleanup_total[1h]) > 10
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: 'Frequent pressure cleanup events'
          description: '{{ $value }} cleanup events in the last hour - system under sustained pressure'

      # ==========================================================================
      # Circuit Breaker Alerts (2025-12)
      # ==========================================================================

      # Circuit Breaker Open
      - alert: CircuitBreakerOpen
        expr: |
          ringrift_circuit_breaker_state == 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'Circuit breaker OPEN for {{ $labels.operation_type }}/{{ $labels.target }}'
          description: 'Circuit breaker has been OPEN for 5+ minutes - operations are being blocked'

      # Circuit Breaker Stuck Open
      - alert: CircuitBreakerStuckOpen
        expr: |
          ringrift_circuit_breaker_state == 1
        for: 30m
        labels:
          severity: critical
        annotations:
          summary: 'Circuit breaker stuck OPEN for {{ $labels.operation_type }}/{{ $labels.target }}'
          description: 'Circuit breaker has been OPEN for 30+ minutes - may indicate persistent failure'

      # High Circuit Breaker Failure Rate
      - alert: HighCircuitBreakerFailures
        expr: |
          increase(ringrift_circuit_breaker_failures_total[15m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: 'High failure rate for {{ $labels.operation_type }}/{{ $labels.target }}'
          description: '{{ $value }} failures in 15 minutes - check target system health'

      # Training Blocked by Circuit Breaker
      - alert: TrainingBlockedByCircuitBreaker
        expr: |
          increase(ringrift_circuit_breaker_blocked_total{operation_type="training"}[1h]) > 0
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: 'Training blocked by circuit breaker'
          description: 'Training operations are being blocked by open circuit breaker'

      # Multiple Circuit Breakers Open
      - alert: MultipleCircuitBreakersOpen
        expr: |
          count(ringrift_circuit_breaker_state == 1) > 3
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: 'Multiple circuit breakers OPEN'
          description: '{{ $value }} circuit breakers are currently OPEN - may indicate cluster-wide issue'
